{% extends "base.html" %}
{% block title %}Posts{% endblock %}
{% block content %}
<h1 align="center">{% block header %}Reviews{% endblock %}</h1>

<div id="posts">
    {% for post in posts %}
        <div class="card border-dark mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <a href="/posts/{{post.author}}" class="text-decoration-none">
                    {{post.author}}
                </a>
                {% if session['user'] == post.author %}
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown"></button>
                    <ul class="dropdown-menu">
                        <li><a href="/delete-post/{{post.id}}" class="dropdown-item text-danger">Delete</a></li>
                        <li><a href="/edit-post/{{post.id}}" class="dropdown-item">Edit</a></li>
                    </ul>
                </div>
                {% endif %}
            </div>
            
            <div class="card-body">
                <!-- Star Rating Display -->
                <div class="mb-3">
                    {% if post.ratings is not none %}
                    <div class="star-rating-display d-flex align-items-center">
                        <div class="stars me-2">
                            {% for i in range(1, 6) %}
                                <span class="star {% if i <= post.ratings %}filled{% endif %}">â˜…</span>
                            {% endfor %}
                        </div>
                        <span class="rating-badge text-white px-2 py-1 rounded">
                            {{ post.ratings }}/5
                        </span>
                    </div>
                    {% else %}
                    <div class="no-rating text-muted">
                        <i class="fas fa-star-half-alt"></i> No rating provided
                    </div>
                    {% endif %}
                </div>
                
                <!-- Post Content -->
                <div class="card-text mb-3">{{post.text}}</div>
                
                <!-- Comments Section -->
                <div class="comments-section">
                    <div class="collapse" id="comments-{{post.id}}">
                        <div class="card card-body bg-light">
                            {% for comment in post.comments %}
                                <div class="comment-item d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <a href="/posts/{{comment.author}}" class="text-decoration-none">
                                            <strong>{{comment.author}}</strong>
                                        </a>: 
                                        <span>{{comment.text}}</span>
                                    </div>
                                    {% if session['user'] == comment.author or session['user'] == post.author %}
                                    <div class="comment-actions">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown"></button>
                                            <ul class="dropdown-menu">
                                                <li><a href="/delete-comment/{{comment.id}}" class="dropdown-item text-danger">Delete</a></li>
                                                <li><a href="/edit-comment/{{comment.id}}" class="dropdown-item">Edit</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if not loop.last %}<hr class="my-1">{% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <p class="mt-2 mb-3">
                        {% if post.comments|length > 0 %}
                            <a data-bs-toggle="collapse" href="#comments-{{post.id}}" role="button" class="text-decoration-none">
                                <small class="text-primary">
                                    <i class="fas fa-comments"></i> View {{post.comments|length}} comment(s)
                                </small>
                            </a>
                        {% else %}
                            <small class="text-muted">
                                <i class="far fa-comment"></i> No comments yet
                            </small>
                        {% endif %}
                    </p>
                    
                    {% if 'user' in session %}
                    <form class="comment-form input-group mb-0" method="POST" action="/create-comment/{{post.id}}">
                        <input type="text" name="text" class="form-control" placeholder="Write a comment..." required>
                        <button type="submit" class="btn btn-outline-primary">Comment
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>

{% block footer %}
<div class="text-center mt-4">
    <a href="/create-post" class="btn btn-primary btn-lg">
        <i class="fas fa-plus"></i> Write a review
    </a>
</div>
{% endblock %}
{% endblock %}

<style>
    /* Star Rating Styles */
    .star-rating-display {
        font-size: 1.25rem;
    }
    .star-rating-display .stars {
        display: inline-block;
    }
    .star-rating-display .star {
        color: #ddd;
        margin: 0 1px;
    }
    .star-rating-display .star.filled {
        color: #ffc107;
        text-shadow: 0 0 2px rgba(255, 193, 7, 0.5);
    }
    .rating-badge {
        font-size: 0.8rem;
        font-weight: bold;
    }
    .no-rating {
        font-size: 0.9rem;
    }
    
    /* Card Styles */
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-header {
        background-color: #f8f9fa;
    }
    
    /* Comment Styles */
    .comment-item {
        padding: 5px 0;
    }
    .comment-form {
        margin-top: 15px;
    }
</style>